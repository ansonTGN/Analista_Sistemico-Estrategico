<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Informe Operativo | Human Intelligence</title>

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <!-- Librer铆a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      /* UI Colors */
      --bg-app: #0f172a;
      --sidebar-bg: #1e293b;
      --border-color: #334155;
      
      /* Paper Colors */
      --paper: #ffffff;
      --text-main: #1e293b;
      --accent: #b45309; 
      --accent-light: #fffbeb;
      --border-paper: #e2e8f0;

      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-app);
      color: #cbd5e1;
      height: 100vh;
      overflow: hidden; 
      display: flex;
      flex-direction: column;
    }

    /* --- TOPBAR RESPONSIVE --- */
    .topbar {
      height: 60px;
      background: var(--sidebar-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      flex-shrink: 0;
      z-index: 50;
    }
    .brand {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: #f1f5f9;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand span.tag {
        background: var(--accent);
        color: white;
        font-family: 'Inter', sans-serif;
        font-size: 0.65rem;
        padding: 3px 6px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .actions { display: flex; gap: 8px; }
    .actions button, .actions a {
        background: transparent;
        border: 1px solid #475569;
        color: #e2e8f0;
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
        font-family: 'Inter', sans-serif;
        display: inline-flex;
        align-items: center;
        white-space: nowrap;
    }
    .actions button:disabled { opacity: 0.5; cursor: not-allowed; }
    .actions button:hover:not(:disabled), .actions a:hover {
        background: #334155;
        border-color: #94a3b8;
    }
    .actions button.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
        font-weight: 600;
    }
    .actions button.primary:hover:not(:disabled) { background: #92400e; }

    /* --- LAYOUT --- */
    .layout-container { display: flex; flex: 1; overflow: hidden; }

    .sidebar {
        width: 280px;
        background: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        padding: 20px;
        overflow-y: auto;
        display: none;
        flex-shrink: 0;
    }
    @media(min-width: 1024px) { .sidebar { display: block; } }

    .toc-title { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; margin-bottom: 16px; font-weight: 700; }
    .toc-link {
        display: block; padding: 8px 12px; color: #cbd5e1; text-decoration: none; font-size: 0.88rem;
        border-radius: 6px; margin-bottom: 4px; border-left: 3px solid transparent; transition: background 0.2s;
    }
    .toc-link:hover { background: #334155; }
    .toc-link.active { background: #334155; color: #fff; border-left-color: var(--accent); }

    .main-area {
        flex: 1; overflow-y: auto; padding: 30px; display: flex;
        justify-content: center; background: #0f172a; position: relative;
    }

    /* --- ESTILOS DEL INFORME (PAPEL) --- */
    #report-container { width: 100%; max-width: 850px; }
    .paper {
        background: var(--paper); color: var(--text-main); padding: 50px 60px;
        min-height: 1000px; box-shadow: var(--shadow); position: relative;
    }

    .paper h1 { font-family: 'Playfair Display', serif; font-size: 2.2rem; border-bottom: 3px solid var(--text-main); padding-bottom: 16px; margin-bottom: 32px; color: #000; line-height: 1.2; }
    .paper h2 { font-family: 'Playfair Display', serif; font-size: 1.6rem; color: #000; margin-top: 40px; margin-bottom: 16px; line-height: 1.3; }
    .paper h3 {
        font-family: 'Inter', sans-serif; font-size: 1.1rem; font-weight: 700; color: #334155;
        margin-top: 30px; margin-bottom: 12px; text-transform: uppercase; border-bottom: 1px solid var(--border-paper); padding-bottom: 6px;
    }
    .paper h4 { font-size: 1rem; font-weight: 700; margin-top: 20px; color: #0f172a; }
    .paper p, .paper li { line-height: 1.65; font-size: 0.98rem; color: #334155; margin-bottom: 10px; }
    
    .report-meta {
        display: flex; justify-content: space-between; font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem; color: #64748b; border-bottom: 1px solid var(--border-paper); padding-bottom: 10px; margin-bottom: 30px; text-transform: uppercase;
        flex-wrap: wrap; gap: 10px;
    }

    /* Tablas */
    .paper table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem; border: 1px solid var(--border-paper); page-break-inside: avoid; }
    .paper th { background: #f8fafc; text-align: left; padding: 10px 12px; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 0.75rem; border-bottom: 2px solid var(--border-paper); }
    .paper td { padding: 10px 12px; border-bottom: 1px solid var(--border-paper); vertical-align: top; }
    
    /* Wrapper para tablas en m贸vil */
    .table-responsive { overflow-x: auto; width: 100%; margin-bottom: 20px; -webkit-overflow-scrolling: touch; }

    /* Grid y Componentes */
    .grid-2 { display: grid; grid-template-columns: 1fr; gap: 20px; margin: 20px 0; }
    @media(min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    
    .card { background: #fff; border: 1px solid var(--border-paper); border-radius: 6px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); page-break-inside: avoid; }
    .executive-summary { background: var(--accent-light); border-left: 4px solid var(--accent); padding: 20px; border-radius: 4px; margin-bottom: 30px; page-break-inside: avoid; }
    .alert-box { padding: 16px 20px; border-radius: 6px; margin: 20px 0; border-left-width: 5px; border-left-style: solid; page-break-inside: avoid; }
    
    .step { display: flex; gap: 16px; margin-bottom: 20px; page-break-inside: avoid; }
    .step-num { flex: 0 0 36px; height: 36px; background: #fff; border: 2px solid var(--accent); color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .step-content { flex: 1; background: #f8fafc; border: 1px solid var(--border-paper); padding: 14px; border-radius: 6px; overflow-wrap: break-word; }

    .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid var(--border-paper); text-align: center; font-size: 0.7rem; color: #94a3b8; font-family: 'JetBrains Mono', monospace; }

    /* --- UTILIDADES PDF (CLONADO) --- */
    #pdf-generator-container {
        position: absolute;
        top: -9999px; /* Fuera de pantalla */
        left: 0;
        width: 800px; /* Ancho fijo A4 aprox */
        z-index: -1;
        background: #ffffff;
    }
    #pdf-generator-container .paper {
        box-shadow: none !important;
        margin: 0 !important;
        padding: 40px !important;
        min-height: auto !important;
        width: 100% !important;
        max-width: none !important;
    }
    #pdf-generator-container .report-meta { color: #000 !important; }

    /* --- MEDIA QUERIES (MVIL) --- */
    @media (max-width: 768px) {
        .topbar {
            height: auto;
            flex-direction: column;
            align-items: flex-start;
            padding: 12px 15px;
            gap: 10px;
        }
        .actions {
            width: 100%;
            justify-content: flex-start;
            flex-wrap: wrap; 
            gap: 8px;
        }
        .actions button, .actions a {
            flex: 1 1 auto;
            justify-content: center;
            padding: 8px 12px;
            font-size: 0.8rem;
        }
        
        .main-area { padding: 0; background: #fff; display: block; height: auto; overflow: visible; }
        .paper { box-shadow: none; padding: 25px 20px; min-height: auto; }
        
        .paper h1 { font-size: 1.6rem; }
        .paper h2 { font-size: 1.35rem; }
        .grid-2 { grid-template-columns: 1fr; }
        .sidebar { display: none !important; }
        
        /* Permitir scroll en la p谩gina entera en m贸vil */
        body { height: auto; overflow-y: auto; }
        .layout-container { display: block; overflow: visible; height: auto; }
    }

  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <span>HUMAN MOTORS</span>
      <span class="tag">INTEL CORE v2.2</span>
    </div>
    <div class="actions">
        <a href="/">Nuevo</a>
        
        <!-- BOTN DESCARGA JSON -->
        {% if case_json %}
        <button onclick="downloadCaseData()" title="Guardar para editar luego"> JSON</button>
        {% endif %}
        
        <button onclick="readReport()" title="Leer en voz alta">Leer</button>
        <button onclick="downloadHTML()" title="Bajar HTML">HTML</button>
        <button class="primary" onclick="downloadPDF()" title="Bajar PDF">PDF</button>
    </div>
  </div>

  <div class="layout-container">
    <aside class="sidebar">
        <div class="toc-title">Tabla de Contenidos</div>
        <nav id="toc"></nav>
    </aside>

    <main class="main-area">
        <div id="report-container">
            <div class="paper" id="report-content">
                <div class="report-meta">
                    <span>CLASIFICACIN: CONFIDENCIAL</span>
                    <span id="date-display">FECHA: </span>
                </div>
                <h1>Informe de Inteligencia Operativa</h1>
                
                {{ report | safe }}
                
                <div class="footer">
                    Generado por Urbina & Meadows Systemic Engine.<br>
                    Las hip贸tesis contenidas requieren verificaci贸n en campo (Ground Truth).
                </div>
            </div>
        </div>
    </main>
  </div>

  <script>
    const now = new Date();
    document.getElementById('date-display').innerText += now.toLocaleDateString('es-ES', { 
        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' 
    }).toUpperCase();

    // 0. FIX TABLAS MVIL
    function makeTablesResponsive() {
        const tables = document.querySelectorAll('.paper table');
        tables.forEach(table => {
            if (!table.parentElement.classList.contains('table-responsive')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-responsive';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            }
        });
    }
    makeTablesResponsive();

    // GENERAR TOC
    function generateTOC() {
        const toc = document.getElementById('toc');
        const headings = document.querySelectorAll('.paper h2, .paper h3');
        if(!toc || headings.length === 0) return;
        headings.forEach((h, index) => {
            const id = 'ref-' + index;
            h.id = id;
            const link = document.createElement('a');
            link.href = '#' + id;
            link.className = 'toc-link';
            link.innerText = h.innerText;
            if(h.tagName === 'H3') { link.style.paddingLeft = '24px'; link.style.fontSize='0.8rem'; }
            link.onclick = (e) => {
                e.preventDefault();
                document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
                document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            };
            toc.appendChild(link);
        });
    }
    setTimeout(generateTOC, 500);

    // ============================================================
    //  FUNCIN DE DESCARGA "NUCLEAR" (Soluci贸n .crdownload)
    // ============================================================
    function downloadBlob(blob, filename) {
        // 1. Crear URL persistente (No revocamos manualmente para evitar cortes)
        const url = URL.createObjectURL(blob);
        
        // 2. Crear elemento ancla
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        
        // 3. Truco para m贸viles: hacerlo "visible" pero invisible
        a.style.position = 'absolute';
        a.style.left = '-9999px';
        a.style.opacity = '0';
        document.body.appendChild(a);
        
        // 4. Disparar
        setTimeout(() => {
            a.click();
            // No eliminamos 'a' ni revocamos URL inmediatamente.
            console.log("Descarga iniciada: " + filename);
        }, 100);
    }

    // 1. DESCARGA JSON
    function downloadCaseData() {
        {% if case_json %}
        try {
            const data = {{ case_json | safe }};
            const jsonStr = JSON.stringify(data, null, 2);
            // Usamos octet-stream para forzar descarga
            const blob = new Blob([jsonStr], { type: 'application/octet-stream' });
            
            const name = data.target_name ? data.target_name.replace(/[^a-z0-9]/gi, '_') : 'Sujeto';
            downloadBlob(blob, `Case_Data_${name}_${Date.now()}.json`);
        } catch (e) {
            console.error(e);
            alert("Error preparando datos JSON.");
        }
        {% else %}
        alert("No hay datos disponibles.");
        {% endif %}
    }

    // 2. DESCARGA PDF
    async function downloadPDF() {
        const btn = document.querySelector('button.primary');
        const originalText = btn.innerText;

        try {
            btn.innerText = "Procesando...";
            btn.disabled = true;
            document.body.style.cursor = 'wait';

            // A. Clonar el DOM
            const source = document.getElementById('report-content');
            const container = document.createElement('div');
            container.id = 'pdf-generator-container';
            const clone = source.cloneNode(true);
            container.appendChild(clone);
            document.body.appendChild(container);

            const filename = `Informe_HM_${Date.now()}.pdf`;

            // B. Configuraci贸n
            const opt = {
                margin: [15, 15, 15, 15],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    scrollY: 0, 
                    logging: false,
                    windowWidth: 800 
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };

            // C. Generar BLOB
            const worker = html2pdf().set(opt).from(clone).toPdf();
            const pdfBlob = await worker.output('blob');

            // D. Forzar tipo binario puro para evitar previsualizaci贸n
            const safeBlob = new Blob([pdfBlob], { type: 'application/octet-stream' });

            // E. Descargar
            downloadBlob(safeBlob, filename);

            // F. Limpieza DOM (La URL del blob se queda en memoria para seguridad)
            document.body.removeChild(container);

        } catch (e) {
            console.error(e);
            alert("Error PDF. Use 'Bajar HTML' si persiste el problema.");
        } finally {
            document.body.style.cursor = 'default';
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // 3. DESCARGA HTML
    function downloadHTML() {
        const content = document.getElementById('report-container').innerHTML;
        const styles = Array.from(document.querySelectorAll('style')).map(s => s.innerText).join('\n');
        
        const fullHtml = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Informe Export</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<style>
    body { background: #f1f5f9; padding: 40px; margin: 0; font-family: 'Inter', sans-serif; }
    .paper { margin: 0 auto; max-width: 850px; background: #fff; padding: 60px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    ${styles}
    .topbar, .sidebar, .actions { display: none !important; } 
    nav { display:none; }
    #pdf-generator-container { display: none; }
</style>
</head>
<body><div class="paper">${content}</div></body></html>`;

        // Usamos octet-stream tambi茅n aqu铆
        const blob = new Blob([fullHtml], { type: 'application/octet-stream' });
        downloadBlob(blob, `Informe_HM_${Date.now()}.html`);
    }

    // 4. TTS
    function readReport() {
        window.speechSynthesis.cancel();
        const text = document.getElementById('report-content').innerText;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'es-ES'; u.rate = 1.1;
        window.speechSynthesis.speak(u);
    }
  </script>
</body>
</html>




